{% extends "inventory/base.html" %}
{% load static %}
{% block title %}Escaneo (c√°mara + manual) ¬∑ Smart Inventory{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto bg-[#d6ecec] rounded-xl p-6 shadow-md border border-[#c3dede]">

  <h1 class="text-3xl font-bold text-center text-teal-700">¬°Escaneo (c√°mara + manual)!</h1>

  <!-- Secci√≥n C√°mara -->
  <h2 class="text-xl font-semibold text-slate-900">C√°mara</h2>
  <div class="flex flex-wrap items-center gap-4 mb-4">
    <button id="switchBtn" type="button"
            class="px-4 py-2 bg-teal-600 text-white rounded hover:bg-teal-700 disabled:opacity-50 disabled:cursor-not-allowed transition">
      Cambiar c√°mara
    </button>
    <span id="cam-status" class="text-sm text-slate-700">Esperando permisos de la c√°mara‚Ä¶</span>
  </div>
  <div id="reader" class="w-full max-w-sm max-h-[40vh] sm:max-h-[60vh] overflow-hidden border border-slate-300 rounded bg-white"></div>

  <!-- Formulario manual -->
  <h2 class="text-xl font-semibold mt-6 text-slate-900">Formulario manual</h2>
  <form onsubmit="event.preventDefault(); enviar();" class="space-y-4">
    {% csrf_token %}

    <!-- üîé Buscador con autocompletado -->
    <div>
      <label for="productSearch" class="block font-medium text-slate-800">Buscar producto</label>
      <input id="productSearch" class="w-full border border-slate-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500"
             placeholder="Escribe nombre, SKU o PRD..."
             list="productSearchResults" autocomplete="off" />
      <datalist id="productSearchResults"></datalist>
      <p class="text-xs text-slate-500 mt-1">
        Al seleccionar una sugerencia se rellenar√° el campo Payload autom√°ticamente.
      </p>
    </div>

    <div>
      <label for="payload" class="block font-medium text-slate-800">Payload (PRD:&lt;uuid&gt;)</label>
      <input id="payload" class="w-full border border-slate-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500" />
    </div>

    <div>
      <label for="loc" class="block font-medium text-slate-800">Ubicaci√≥n</label>
      <select id="loc" class="w-full border border-slate-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500">
        <option value="" disabled selected>--- Elige ubicaci√≥n ---</option>
        {% for loc in locations %}
          <!-- value = public_id (UUID), texto = ruta completa -->
          <option value="{{ loc.public_id }}">{{ loc.path }}</option>
        {% empty %}
          <option disabled>No hay ubicaciones disponibles</option>
        {% endfor %}
      </select>
    </div>

    <div>
      <label for="mtype" class="block font-medium text-slate-800">Tipo</label>
      <select id="mtype" class="w-full border border-slate-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500">
        <option value="OUT">Salida</option>
        <option value="IN">Entrada</option>
        <option value="ADJ">Ajuste</option>
        <option value="AUD">Auditor√≠a</option>
        <option value="AUDTOTAL">Auditor√≠a total</option>
      </select>
      <!-- B√∫squeda avanzada (solo AUD) -->
      <div id="aud-filters" class="space-y-4 hidden mt-4">
        <div>
          <label for="aud_name" class="block font-medium text-slate-800">Nombre</label>
          <input id="aud_name" type="text"
                class="w-full border border-slate-300 rounded px-3 py-2"
                placeholder="Ej: camiseta" />
        </div>

        <div>
          <label for="aud_category" class="block font-medium text-slate-800">Categor√≠a</label>
          <input id="aud_category" type="text"
                class="w-full border border-slate-300 rounded px-3 py-2"
                placeholder="Ej: ropa" />
        </div>

        <div>
          <label for="aud_brand" class="block font-medium text-slate-800">Marca</label>
          <input id="aud_brand" type="text"
                class="w-full border border-slate-300 rounded px-3 py-2"
                placeholder="Ej: Bosch" />
        </div>

        <div>
          <label for="aud_origin" class="block font-medium text-slate-800">Origen</label>
          <input id="aud_origin" type="text"
                class="w-full border border-slate-300 rounded px-3 py-2"
                placeholder="Ej: Alemania" />
        </div>

        <div>
          <label for="aud_primary_color" class="block font-medium text-slate-800">Color principal</label>
          <input id="aud_primary_color" type="text"
                class="w-full border border-slate-300 rounded px-3 py-2"
                placeholder="Ej: Azul" />
        </div>

        <div>
          <label for="aud_dimensions" class="block font-medium text-slate-800">Dimensiones</label>
          <input id="aud_dimensions" type="text"
                class="w-full border border-slate-300 rounded px-3 py-2"
                placeholder="Ej: 10x20x5 cm" />
        </div>
      </div>

    </div>

    <div id="open-options" class="space-y-3 hidden">
      <div class="flex items-center gap-2">
        <input type="checkbox" id="mark_open" class="h-4 w-4">
        <label for="mark_open" class="font-medium text-slate-800">Marcar como abierto</label>
      </div>

      <div>
        <label for="open_days" class="block font-medium text-slate-800">D√≠as de vida tras abrir</label>
        <input id="open_days"
              type="number"
              min="1"
              class="w-full border border-slate-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500"
              placeholder="Ej: 7 para caducar en 7 d√≠as" />
      </div>
    </div>

    <!-- Campos adicionales SOLO cuando tipo = Entrada -->
    <div id="entrada-extra" class="space-y-4 hidden mt-4">
      <div>
        <label for="new_name" class="block font-medium text-slate-800">Nombre del producto</label>
        <input id="new_name" class="w-full border border-slate-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500" />
      </div>
      <div>
        <label for="new_category" class="block font-medium text-slate-800">Categor√≠a</label>
        <input id="new_category" class="w-full border border-slate-300 rounded px-3 py-2" />
      </div>
      <div>
        <label for="new_unit" class="block font-medium text-slate-800">Unidad</label>
        <input id="new_unit" class="w-full border border-slate-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500" />
      </div>
      <div>
        <label for="new_min_stock" class="block font-medium text-slate-800">Stock m√≠nimo</label>
        <input id="new_min_stock" type="number" class="w-full border border-slate-300 rounded px-3 py-2" />
      </div>
      <div>
        <label for="new_expiration_date" class="block font-medium text-slate-800">Fecha de caducidad</label>
        <input id="new_expiration_date" type="date" class="w-full border border-slate-300 rounded px-3 py-2" />
      </div>
      <!-- --- Metadatos opcionales del producto (v0.1) --- -->

      <div>
        <label for="new_brand" class="block font-medium text-slate-800">Marca</label>
        <input
          id="new_brand"
          type="text"
          class="w-full border border-slate-300 rounded px-3 py-2"
          placeholder="Ej: Bosch"
        />
      </div>

      <div>
        <label for="new_origin" class="block font-medium text-slate-800">Origen</label>
        <input
          id="new_origin"
          type="text"
          class="w-full border border-slate-300 rounded px-3 py-2"
          placeholder="Ej: Lidl"
        />
      </div>

      <div>
        <label for="new_primary_color" class="block font-medium text-slate-800">Color principal</label>
        <input
          id="new_primary_color"
          type="text"
          class="w-full border border-slate-300 rounded px-3 py-2"
          placeholder="Ej: Azul"
        />
      </div>

      <div>
        <label for="new_dimensions" class="block font-medium text-slate-800">Dimensiones</label>
        <input
          id="new_dimensions"
          type="text"
          class="w-full border border-slate-300 rounded px-3 py-2"
          placeholder="Ej: 10x20x5 cm"
        />
      </div>

      <div>
        <label for="new_estimated_value" class="block font-medium text-slate-800">
          Valor estimado (‚Ç¨)
        </label>
        <input
          id="new_estimated_value"
          type="number"
          step="0.01"
          min="0"
          class="w-full border border-slate-300 rounded px-3 py-2"
          placeholder="Ej: 49.99"
        />
      </div>

      <div>
        <label for="new_notes" class="block font-medium text-slate-800">Notas</label>
        <textarea id="new_notes" class="w-full border border-slate-300 rounded px-3 py-2"></textarea>
      </div>
    </div>

    <div>
      <label for="qty" class="block font-medium text-slate-800">Cantidad</label>
      <input id="qty" type="number" value="1" min="1"
             class="w-full border border-slate-300 rounded px-3 py-2" />
    </div>

    <button class="w-full bg-teal-600 text-white py-2 px-4 rounded hover:bg-teal-700 transition">
      Enviar
    </button>
  </form>

  <!-- Resultados -->
  <h3 class="text-lg font-semibold mt-6 text-slate-900">Resultados:</h3>

  <!-- Solo OUT (tarjeta & FIFO) + IN "bonito" -->
  <section id="out-section"
           class="mt-2 bg-slate-50 border border-slate-200 p-4 rounded min-h-[64px]"></section>

  <!-- Solo AUD / AUDTOTAL -->
  <section id="audit-section"
           class="mt-4 bg-slate-50 border border-slate-200 p-4 rounded"></section>

  <div id="qr-result" class="mt-4 hidden">
    <h4 class="font-semibold text-slate-900">QR generado:</h4>
    <canvas id="qr-canvas" class="border border-slate-300 rounded p-2 bg-white"></canvas>
    <p class="text-sm text-slate-600 mt-1">Este c√≥digo identifica el producto generado.</p>
  </div>

</div>
{% endblock %}

{% block extra_js %}
{# Librer√≠as externas necesarias para el esc√°ner y los QR #}
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"
        onerror="this.onerror=null; this.src='https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js'"></script>
<script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>


<script>

// =============================
// ENDPOINTS API OFICIALES
// =============================
const API_SCAN = "/api/scan/";
const API_PRODUCT_SEARCH = "/api/products/search/";


// =============================
// CONTRATO /api/scan/ (documentado)
// =============================
// El backend espera estructuras de este tipo:
//
// {
//   movement_type: "IN" | "OUT" | "AUD" | "AUDTOTAL",
//   payload: "PRD:<uuid>" | "",
//   location: "<uuid_location_public_id>" | "",
//   quantity: number,
//   mark_open: boolean,
//   open_days: number | null,
//   new_product?: {
//     name: string,
//     category: string,
//     unit: string,
//     min_stock: number,
//     notes: string,
//     expiration_date: "YYYY-MM-DD" | null
//   }
// }
//
// Esto sirve como referencia para mantener el contrato claro
// y evitar errores al modificar el frontend o backend.


// ---- Utilidades CSRF + helpers ----
function getCookie(name) {
  const v = `; ${document.cookie}`;
  const p = v.split(`; ${name}=`);
  if (p.length === 2) return p.pop().split(';').shift();
}
const csrftoken = getCookie('csrftoken');

function validUUID(u) {
  return /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(u);
}

// ---- Contenedores separados de render ----
const $OUT = () => document.getElementById('out-section');
const $AUD = () => document.getElementById('audit-section');

function clearOUT() { $OUT().innerHTML = ''; }
function clearAUD() { $AUD().innerHTML = ''; }


// =============================
// üß± RENDER (bloque de producto)
// =============================
function showVal(v) {
  return (v !== null && v !== undefined && v !== '') ? v : '‚Äì';
}

function toggleDetails(btn) {
  const container = btn.closest('.product-block');
  const details = container.querySelector('.product-details');
  const isHidden = details.classList.contains('hidden');

  details.classList.toggle('hidden');
  btn.textContent = isHidden ? '‚ñ¥' : '‚ñæ';
}

function renderProductBlock(it) {
  const name = showVal(it.product ?? it.name);
  const qty = showVal(it.total_quantity);
  const nearest = showVal(it.nearest_expiration);

  const category = showVal(it.category);
  const unit = showVal(it.unit);
  const brand = showVal(it.brand);
  const origin = showVal(it.origin);
  const color = showVal(it.primary_color);
  const dims = showVal(it.dimensions);
  const value = (it.estimated_value !== null && it.estimated_value !== undefined && it.estimated_value !== '')
    ? `${it.estimated_value} ‚Ç¨`
    : '‚Äì';
  const notes = showVal(it.notes);

  // Lotes (si vienen)
  const batches = Array.isArray(it.batches) ? it.batches : [];
  let batchesHtml = '';
  if (batches.length) {
    batchesHtml = `
      <div class="mt-3">
        <div class="text-xs font-semibold text-slate-700 mb-1">Lotes</div>
        <div class="space-y-1">
          ${batches.map(b => {
            const opened = (b.opened_units && b.opened_units > 0) ? b.opened_units : 0;
            const openExp = b.open_expires_at ? b.open_expires_at : null;

            // Si est√° abierto, queremos: Open: X ¬∑ Exp(open): fecha
            // Si no, queremos: Open: 0
            const openLine = opened > 0
              ? `<span class="text-orange-700 font-medium">
                  <b>Open:</b> ${opened}${openExp ? ` ¬∑ <b>Exp(open):</b> ${openExp}` : ''}
                </span>`
              : `<span><b>Open:</b> 0</span>`;

            return `
              <div class="text-xs text-slate-600 flex flex-wrap gap-x-3 gap-y-1">
                <span><b>Exp:</b> ${showVal(b.expiration_date)}</span>
                ${openLine}
              </div>
            `;
          }).join('')}

        </div>
      </div>
    `;
  }

  return `
    <div class="product-block border border-slate-200 rounded-lg p-3 bg-white">
      <div class="flex items-start justify-between gap-3">
        <div class="min-w-0">
          <div class="font-semibold text-slate-900 truncate">${name}</div>
          <div class="text-sm text-slate-600 mt-0.5">
            Cantidad: <b>${qty}</b> ¬∑ Caducidad pr√≥xima: <b>${nearest}</b>
          </div>
        </div>
        <button type="button"
          class="shrink-0 w-8 h-8 rounded hover:bg-slate-100 text-slate-700"
          onclick="toggleDetails(this)">‚ñæ</button>
      </div>

      <div class="product-details hidden mt-3 text-sm text-slate-700 space-y-1">
        <div><b>Categor√≠a:</b> ${category}</div>
        <div><b>Unidad:</b> ${unit}</div>
        <div><b>Marca:</b> ${brand}</div>
        <div><b>Origen:</b> ${origin}</div>
        <div><b>Color:</b> ${color}</div>
        <div><b>Dimensiones:</b> ${dims}</div>
        <div><b>Valor estimado:</b> ${value}</div>
        <div><b>Notas:</b> ${notes}</div>
        ${batchesHtml}
      </div>
    </div>
  `;
}



// =============================
// üîé AUTOCOMPLETADO DE PRODUCTOS
// =============================
(function initProductAutocomplete() {
  const searchInput   = document.getElementById('productSearch');
  const datalist      = document.getElementById('productSearchResults');
  const payloadInput  = document.getElementById('payload');
  const locationSelect= document.getElementById('loc');

  // Mapa label -> payload
  const optionMap = new Map();
  let timer = null;
  let lastController = null;

  function debounce(fn, ms) {
    clearTimeout(timer);
    timer = setTimeout(fn, ms);
  }

  async function fetchResults(q) {
    try {
      if (lastController) lastController.abort();
      lastController = new AbortController();

      const params = new URLSearchParams({ q });
      const loc = (locationSelect && locationSelect.value) ? locationSelect.value.trim() : '';
      if (loc) params.set('location', loc);

      const res = await fetch(`${API_PRODUCT_SEARCH}?${params.toString()}`, { signal: lastController.signal });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      return await res.json();
    } catch (_e) {
      return { results: [] };
    }
  }

  function renderOptions(results) {
    optionMap.clear();
    datalist.innerHTML = results.map(r => {
      const label = [r.name, r.location].filter(Boolean).join(' ‚Äî ');
      optionMap.set(label, r.payload);
      return `<option value="${label}"></option>`;
    }).join('');
  }

  if (searchInput) {
    searchInput.addEventListener('input', () => {
      const q = searchInput.value.trim();
      if (!q) { datalist.innerHTML = ''; optionMap.clear(); return; }
      debounce(async () => {
        const json = await fetchResults(q);
        renderOptions(json.results || []);
      }, 250);
    });

    searchInput.addEventListener('change', () => {
      const val = searchInput.value.trim();
      if (optionMap.has(val)) {
        payloadInput.value = optionMap.get(val); // PRD:...
      }
    });
  }
})();
// =============================

// ---- Env√≠o de formulario ----

async function enviar() {
  const mtype = document.getElementById('mtype').value;

  // Limpiar contenedores seg√∫n tipo
  if (mtype === 'OUT' || mtype === 'ADJ') clearOUT();
  if (mtype === 'AUD' || mtype === 'AUDTOTAL') clearAUD();

  const payloadRaw = (document.getElementById('payload').value || '').trim();

  // Referencias a campos de Entrada (IN)
  const newNameEl       = document.getElementById('new_name');
  const newCategoryEl   = document.getElementById('new_category');
  const newUnitEl       = document.getElementById('new_unit');
  const newMinStockEl   = document.getElementById('new_min_stock');
  const newNotesEl      = document.getElementById('new_notes');
  const newExpDateEl    = document.getElementById('new_expiration_date');
  const newBrandEl        = document.getElementById('new_brand');
  const newOriginEl       = document.getElementById('new_origin');
  const newColorEl        = document.getElementById('new_primary_color');
  const newDimensionsEl   = document.getElementById('new_dimensions');
  const newValueEl        = document.getElementById('new_estimated_value');


  // Reset visual de errores en campos de IN
  if (newNameEl) {
    newNameEl.classList.remove('border-red-500');
    newNameEl.classList.add('border-gray-300');
  }
  if (newUnitEl) {
    newUnitEl.classList.remove('border-red-500');
    newUnitEl.classList.add('border-gray-300');
  }

  // Validaci√≥n del payload seg√∫n el tipo de movimiento
  if (!['IN', 'AUD', 'AUDTOTAL'].includes(mtype)) {
    // OUT y ADJ: payload PRD obligatorio
    if (!payloadRaw.startsWith('PRD:')) { 
      alert('El payload debe empezar por PRD:'); 
      return; 
    }
    const uuid = payloadRaw.slice(4).trim();
    if (!validUUID(uuid)) { 
      alert('UUID no v√°lido.'); 
      return; 
    }
  }

  // Validaci√≥n espec√≠fica para IN:
  // Caso 1: IN con PRD:uuid v√°lido -> se asume producto existente (nombre/unidad opcionales)
  // Caso 2: IN sin PRD (o PRD mal formado) -> alta de producto nuevo -> nombre + unidad OBLIGATORIOS
  if (mtype === 'IN') {
    const maybeUuid = payloadRaw.startsWith('PRD:') ? payloadRaw.slice(4).trim() : '';
    const hasValidPRD = maybeUuid && validUUID(maybeUuid);

    if (!hasValidPRD) {
      const newName = (newNameEl?.value || '').trim();
      const newUnit = (newUnitEl?.value || '').trim();
      let missing = [];

      if (!newName) {
        missing.push('nombre');
        if (newNameEl) {
          newNameEl.classList.remove('border-gray-300');
          newNameEl.classList.add('border-red-500');
        }
      }
      if (!newUnit) {
        missing.push('unidad');
        if (newUnitEl) {
          newUnitEl.classList.remove('border-gray-300');
          newUnitEl.classList.add('border-red-500');
        }
      }

      if (missing.length) {
        // Mensaje de error en la zona de resultados (OUT)
        $OUT().innerHTML = `
          <div class="p-4 bg-red-50 border border-red-200 rounded">
            <div class="font-semibold text-red-700">Faltan campos obligatorios</div>
            <div class="text-sm text-red-700 mt-1">
              Para una <b>entrada sin PRD</b> tienes que indicar como m√≠nimo
              <b>nombre</b> y <b>unidad</b> del producto.
            </div>
          </div>
        `;
        return;
      }
    }
  }

  const body = {
      payload: payloadRaw,
      quantity: document.getElementById('qty').value || 1,
      location: document.getElementById('loc').value || '',
      movement_type: mtype,
      mark_open: document.getElementById("mark_open")?.checked || false,
      open_days: document.getElementById("open_days")?.value || null,
  };

  // --- Auditor√≠a: enviar filtros avanzados ---
if (mtype === 'AUD') {
  body.audit_filters = {
    name: (document.getElementById('aud_name')?.value || '').trim(),
    category: (document.getElementById('aud_category')?.value || '').trim(),
    brand: (document.getElementById('aud_brand')?.value || '').trim(),
    origin: (document.getElementById('aud_origin')?.value || '').trim(),
    primary_color: (document.getElementById('aud_primary_color')?.value || '').trim(),
    dimensions: (document.getElementById('aud_dimensions')?.value || '').trim(),
  };
}


  if (mtype === 'IN') {
    body.new_product = {
      name: newNameEl?.value || '',
      category: newCategoryEl?.value || '',
      unit: newUnitEl?.value || '',
      min_stock: parseInt(newMinStockEl?.value || '0'),
      notes: newNotesEl?.value || '',
      expiration_date: newExpDateEl?.value || null,

      // --- metadatos opcionales (v0.1) ---
      brand: newBrandEl?.value || '',
      origin: newOriginEl?.value || '',
      primary_color: newColorEl?.value || '',
      dimensions: newDimensionsEl?.value || '',
      estimated_value: newValueEl?.value
        ? parseFloat(newValueEl.value)
        : null,
    };
  }

  try {
    const res = await fetch(API_SCAN, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
      credentials: 'same-origin',
      body: JSON.stringify(body),
    });

    const raw = await res.text();
    let data;
    try { data = JSON.parse(raw); } catch { data = { non_json: true, raw }; }

    const headersObj = {};
    res.headers.forEach((v, k) => headersObj[k] = v);

    // --- AUDITOR√çA: si no hay resultados, mostrar mensaje y salir ---
    if (mtype === 'AUD') {
      const items = data?.items || data?.data?.items || data?.data?.data?.items || [];
      const total = data?.total_products ?? data?.data?.total_products ?? data?.data?.data?.total_products ?? items.length;

      if (Array.isArray(items) && items.length === 0) {
        $AUD().innerHTML = `
          <div class="p-4 bg-yellow-50 border border-yellow-300 rounded text-slate-800">
            No se encontr√≥ ning√∫n producto con los criterios indicados.
          </div>
        `;
        return;
      }
    }


    // AUDITOR√çA TOTAL ‚Äî versi√≥n simplificada y fiable (render SOLO en #audit-section)
if (mtype === 'AUDTOTAL') {
  const inv = data?.data?.inventory || data?.inventory || data?.data?.data?.inventory;
  const total = data?.data?.total_locations || data?.total_locations || data?.data?.data?.total_locations;

  if (!inv || !Array.isArray(inv)) {
    $AUD().innerHTML = `
      <div class="p-4 bg-red-100 text-red-700 rounded">
        <strong>Error:</strong> No se pudo leer el inventario desde la respuesta del servidor.
      </div>
      <pre class="mt-2 text-xs text-gray-600 overflow-x-auto">${JSON.stringify(data, null, 2)}</pre>
    `;
    return;
  }

  let html = `
    <h2 class="text-2xl font-bold text-blue-600 mb-3">üì¶ Auditor√≠a total</h2>
    <p class="text-sm text-gray-700 mb-6">
      Total de ubicaciones: <b>${total || inv.length}</b>
    </p>
  `;

  inv.forEach(loc => {
    const blocks = (loc.items || []).map(it => renderProductBlock(it)).join("");

    html += `
      <div class="border border-gray-300 rounded-lg p-4 mb-5 bg-gray-50">
        <h3 class="text-lg font-semibold text-gray-800 mb-2">${loc.location}</h3>
        <p class="text-sm text-gray-600 mb-3">
          Productos en esta ubicaci√≥n: <b>${loc.total_products}</b>
        </p>
        <div class="space-y-3">
          ${blocks || '<div class="text-sm text-gray-400 italic">Sin productos</div>'}
        </div>
      </div>
    `;
  });

  $AUD().innerHTML = html;
  return;
}


    // ENTRADA (IN) ‚Äî QR + tarjeta bonita en OUT y salir
    if (mtype === 'IN') {
      // inner = datos reales de la API (por si vienen anidados en data.data)
      const inner = (data && (data.payload !== undefined || data.detail !== undefined))
                    ? data
                    : (data && data.data) || data || {};

      const qrValue = inner.payload || payloadRaw || '';
      if (qrValue) {
        const qrCanvas = document.getElementById('qr-canvas');
        const qrContainer = document.getElementById('qr-result');
        qrContainer.classList.remove('hidden');
        new QRious({ element: qrCanvas, value: qrValue, size: 200, level: 'H' });
      }

      const detailText = inner.detail || 'Entrada registrada correctamente';
      const shownPayload = inner.payload || payloadRaw || '(no disponible)';
      const locText = body.location || '-';
      const qtyText = body.quantity || 1;

      $OUT().innerHTML = `
        <div class="p-4 bg-blue-50 border border-blue-200 rounded mb-2">
          <div class="font-semibold text-blue-800">
            ‚úÖ ${detailText}
          </div>
          <div class="mt-2 text-sm text-blue-900 space-y-1">
            <p>Ubicaci√≥n: <b>${locText}</b></p>
            <p>Cantidad recibida: <b>${qtyText}</b></p>
            <p>Payload / PRD:
              <code class="text-xs bg-blue-100 px-1 py-0.5 rounded">${shownPayload}</code>
            </p>
          </div>
        </div>
      `;
      return;
    }

    // SALIDA (OUT) ‚Äî mostrar detalle de lotes consumidos si la petici√≥n fue OK (render SOLO en #out-section)
    if (mtype === 'OUT') {
      // 2.1 ‚Äî Acci√≥n OPENED (marcar como abierto)
      if (data && data.action === "OPENED") {
        $OUT().innerHTML = `
          <div class="p-4 bg-yellow-50 border border-yellow-200 rounded mb-4">
            <div class="font-semibold text-yellow-800">
              ‚úÖ ${data.detail}
            </div>
            <div class="mt-2 text-sm text-yellow-900 space-y-1">
              <p><b>Lote abierto:</b> #${data.batch_id}</p>
              <p><b>Caduca tras abrir:</b> ${
                data.open_expires_at ? data.open_expires_at : "‚Äî"
              }</p>
            </div>
          </div>
        `;
        return;
      }

      if (data && data.ok) {
        const rows = (data.consumed_batches || []).map(cb => `
          <tr class="hover:bg-gray-50">
            <td class="border px-3 py-2 text-center">${cb.batch_id}</td>
            <td class="border px-3 py-2 text-center">${cb.prev_qty}</td>
            <td class="border px-3 py-2 text-center">‚àí${cb.taken}</td>
            <td class="border px-3 py-2 text-center">${cb.new_qty}</td>
            <td class="border px-3 py-2 text-center">${cb.expiration_date || '-'}</td>
          </tr>
        `).join("");

        // Info extra de caducidades globales
        const nearest = data.nearest_expiration;
        const farthest = data.farthest_expiration;

        let expInfo = "";
        if (nearest && farthest) {
          if (nearest === farthest) {
            expInfo = `
              <div class="text-xs text-gray-600">
                Caducidad de los lotes restantes: <b>${nearest}</b>
              </div>`;
          } else {
            expInfo = `
              <div class="text-xs text-gray-600">
                Lote m√°s pr√≥ximo: <b>${nearest}</b> ¬∑ √öltimo lote: <b>${farthest}</b>
              </div>`;
          }
        }

        const html = `
          <div class="p-4 bg-green-50 border border-green-200 rounded mb-4">
            <div class="font-semibold text-green-700">
              ‚úÖ ${data.detail || 'Salida registrada correctamente'}
            </div>
            <div class="text-sm text-green-700 mt-1">
              Producto: <b>${data.product?.name || ''}</b> ‚Äî
              Solicitado: <b>${data.requested}</b> ‚Äî
              Stock total restante: <b>${data.stock_remaining}</b>
            </div>
            ${expInfo}
          </div>

          <h4 class="font-semibold mb-2">Lotes consumidos (FIFO)</h4>
          <p class="text-xs text-gray-500 mb-2">
            Las cantidades de la tabla se refieren a <b>cada lote afectado</b>.
            El stock total restante del producto es <b>${data.stock_remaining}</b>.
          </p>
          <table class="w-full border-collapse text-sm bg-white rounded overflow-hidden">
            <thead class="bg-gray-200 text-gray-800">
              <tr>
                <th class="border px-3 py-2">Lote</th>
                <th class="border px-3 py-2">Cantidad previa en este lote</th>
                <th class="border px-3 py-2">Extra√≠do de este lote</th>
                <th class="border px-3 py-2">Cantidad nueva en este lote</th>
                <th class="border px-3 py-2">Caducidad</th>
              </tr>
            </thead>
            <tbody>${rows || `
              <tr><td class="border px-3 py-2 text-center" colspan="5">
                <i class="text-gray-500">No se registraron lotes</i>
              </td></tr>`}
            </tbody>
          </table>
        `;

        $OUT().innerHTML = html;
        return;
      } else {
        const msg = data?.detail || 'No se pudo registrar la salida.';
        $OUT().innerHTML = `
          <div class="p-4 bg-red-50 border border-red-200 rounded">
            <div class="font-semibold text-red-700">‚ùå ${msg}</div>
            ${data?.available !== undefined ? `
              <div class="text-sm text-red-700 mt-1">
                Disponible: <b>${data.available}</b> ‚Äî Solicitado: <b>${data.requested}</b>
              </div>` : ''}
          </div>`;
        return;
      }
    }

    // AUD ‚Äî render SOLO en #audit-section
    if (mtype === "AUD" && data && data.items) {
      const blocks = (data.items || []).map(it => renderProductBlock(it)).join("");

      const html = `
        <h3 class="text-lg font-semibold mb-2">Auditor√≠a ‚Äî ${data.location}</h3>
        <p class="text-sm text-gray-600 mb-3">
          Total productos: <b>${data.total_products}</b>
        </p>
        <div class="space-y-3">
          ${blocks}
        </div>
      `;

      $AUD().innerHTML = html;
    }
    else {
      // Fallback: JSON crudo al contenedor correspondiente
      const target = (mtype === 'AUD' || mtype === 'AUDTOTAL') ? $AUD() : $OUT();
      target.innerHTML = `
        <pre class="bg-gray-100 border border-gray-300 p-3 rounded text-gray-700 text-xs overflow-x-auto">${
          JSON.stringify({ ok: res.ok, status: res.status, headers: headersObj, data }, null, 2)
        }</pre>`;
    }

  } catch (e) {
    // Error de red o excepci√≥n inesperada durante el env√≠o/procesado
    const target = (mtype === 'AUD' || mtype === 'AUDTOTAL') ? $AUD() : $OUT();
    target.innerHTML = `
      <div class="p-4 bg-red-50 border border-red-200 rounded">
        <div class="font-semibold text-red-700">Error de red</div>
        <pre class="mt-2 text-xs text-gray-600 overflow-x-auto">${String(e)}</pre>
      </div>`;
  }

} // fin function enviar

// ---- Lector QR / C√°mara ----
let html5Qr; let cameras = []; let currentCamIndex = 0; let lastText = null;

function disableCameraUI(message) {
  const statusEl = document.getElementById('cam-status');
  const btn = document.getElementById('switchBtn');
  if (statusEl) {
    statusEl.textContent = message || 'La c√°mara no est√° disponible. Usa el formulario manual para registrar movimientos.';
  }
  if (btn) {
    btn.disabled = true;
  }
  const reader = document.getElementById('reader');
  if (reader) {
    reader.classList.add('bg-gray-100');
  }
}

function onScanSuccess(decodedText) {
  if (decodedText === lastText) return;
  lastText = decodedText;
  document.getElementById('payload').value = decodedText;

  const parts = decodedText.split('|').map(s => s.trim());
  parts.forEach(p => {
    const [key, value] = p.split(':');
    if (!key || !value) return;
    const k = key.toUpperCase();
    if (k === 'LOC') document.getElementById('loc').value = value;
    if (k === 'Q') document.getElementById('qty').value = value;
    if (k === 'T') document.getElementById('mtype').value = value.toUpperCase();
  });
}

function onScanError(_msg) {
  // Podr√≠amos loguear si queremos, pero no es cr√≠tico para el usuario.
}

async function startWithFacingMode() {
  await html5Qr.start(
    { facingMode: "environment" },
    { fps: 12, qrbox: 280, rememberLastUsedCamera: true },
    onScanSuccess,
    onScanError
  );
}

async function listAndStartPreferred() {
  cameras = await Html5Qrcode.getCameras();
  if (!cameras || !cameras.length) {
    throw new Error("SIN_CAMARAS");
  }
  const prefer = cameras.find(c => (c.label || "").toLowerCase().match(/back|rear|environment/));
  currentCamIndex = Math.max(0, prefer ? cameras.indexOf(prefer) : 0);
  await html5Qr.start(
    cameras[currentCamIndex].id,
    { fps: 12, qrbox: 280 },
    onScanSuccess,
    onScanError
  );
}

async function startScanner() {
  const statusEl = document.getElementById('cam-status');
  try {
    html5Qr = new Html5Qrcode("reader");
    try {
      await startWithFacingMode();
      statusEl.textContent = "C√°mara trasera activa. Enfoca un QR‚Ä¶";
    } catch (_e) {
      try {
        await listAndStartPreferred();
        const label = cameras[currentCamIndex]?.label || "c√°mara";
        statusEl.textContent = `C√°mara activa (${label}). Enfoca un QR‚Ä¶`;
      } catch (innerErr) {
        if (innerErr && innerErr.message === "SIN_CAMARAS") {
          disableCameraUI("No se han encontrado c√°maras en este dispositivo. Usa el formulario manual.");
        } else {
          console.error(innerErr);
          disableCameraUI("No se pudo iniciar la c√°mara. Puedes usar el formulario manual sin problema.");
        }
      }
    }
  } catch (e) {
    console.error(e);
    // Casos t√≠picos: permisos denegados, navegador bloquea c√°mara, etc.
    disableCameraUI("No fue posible acceder a la c√°mara (permisos denegados o dispositivo no soportado). Usa el formulario manual.");
  }
}

async function switchCamera() {
  const statusEl = document.getElementById('cam-status');
  try {
    if (!html5Qr || !cameras.length) {
      statusEl.textContent = "No hay m√°s c√°maras disponibles.";
      return;
    }
    await html5Qr.stop(); 
    await html5Qr.clear();
    currentCamIndex = (currentCamIndex + 1) % cameras.length;
    await html5Qr.start(
      cameras[currentCamIndex].id,
      { fps: 12, qrbox: 280 },
      onScanSuccess,
      onScanError
    );
    const label = cameras[currentCamIndex]?.label || "c√°mara";
    statusEl.textContent = `C√°mara activa (${label}). Enfoca un QR‚Ä¶`;
  } catch (e) {
    console.error(e);
    statusEl.textContent = "No se pudo cambiar de c√°mara. Puedes seguir usando el formulario manual.";
  }
}

// ---- Inicializaci√≥n ----
document.addEventListener('DOMContentLoaded', () => {
  console.log("DOM cargado, inicializando esc√°ner...");

  // Mostrar/ocultar campos de Entrada / opciones de abierto
  const tipoSelect = document.getElementById('mtype');
  const extraForm = document.getElementById('entrada-extra');
  const openOptions = document.getElementById('open-options');
  const audFilters = document.getElementById('aud-filters');


  function updateVisibility() {
      const t = tipoSelect.value;

      // Mostrar solo si tipo = IN
      if (t === 'IN') extraForm.classList.remove('hidden');
      else extraForm.classList.add('hidden');

      // Mostrar solo si tipo = OUT
      if (t === 'OUT') openOptions.classList.remove('hidden');
      else openOptions.classList.add('hidden');

      if (t === 'AUD') audFilters.classList.remove('hidden');
      else audFilters.classList.add('hidden');

  }

  tipoSelect.addEventListener('change', updateVisibility);
  updateVisibility();

  // Inicializar c√°mara con comprobaci√≥n de soporte y librer√≠a
  setTimeout(() => {
    const statusEl = document.getElementById('cam-status');

    if (typeof Html5Qrcode === 'undefined') {
      console.error('Html5Qrcode no est√° disponible. Verifica la carga de la librer√≠a.');
      disableCameraUI('La librer√≠a de c√°mara no se ha podido cargar. Usa el formulario manual.');
      return;
    }

    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      console.warn('Este navegador/dispositivo no soporta getUserMedia.');
      disableCameraUI('Este navegador no permite usar c√°mara. Usa el formulario manual para registrar los movimientos.');
      return;
    }

    const switchBtn = document.getElementById('switchBtn');
    if (switchBtn) {
      switchBtn.addEventListener('click', switchCamera);
    }
    startScanner();
  }, 100);
});


</script>
{% endblock %}
