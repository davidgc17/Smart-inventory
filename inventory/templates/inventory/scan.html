{% load static %}
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Escaneo (c√°mara + manual)</title>

  <!-- Librer√≠as externas -->
  <link href="{% static 'css/output.css' %}" rel="stylesheet">
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js" 
          onerror="this.onerror=null; this.src='https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js'"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
</head>

<body class="font-sans bg-gray-100 p-6">
  <div class="max-w-xl mx-auto bg-white shadow-md rounded-xl p-6 space-y-6">

    <h1 class="text-3xl font-bold text-center text-blue-600">¬°Escaneo (c√°mara + manual)!</h1>

    <!-- Secci√≥n C√°mara -->
    <h2 class="text-xl font-semibold">C√°mara</h2>
    <div class="flex flex-wrap items-center gap-4 mb-4">
      <button id="switchBtn" type="button" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Cambiar c√°mara</button>
      <span id="cam-status" class="text-sm text-gray-700">Esperando permisos de la c√°mara‚Ä¶</span>
    </div>
    <div id="reader" class="w-full max-w-sm h-64 border border-gray-300 rounded bg-white"></div>

    <!-- Formulario manual -->
    <h2 class="text-xl font-semibold mt-6">Formulario manual</h2>
    <form onsubmit="event.preventDefault(); enviar();" class="space-y-4">
      {% csrf_token %}

      <!-- üîé Buscador con autocompletado -->
      <div>
        <label for="productSearch" class="block font-medium">Buscar producto</label>
        <input id="productSearch" class="w-full border border-gray-300 rounded px-3 py-2"
               placeholder="Escribe nombre, SKU o PRD..."
               list="productSearchResults" autocomplete="off" />
        <datalist id="productSearchResults"></datalist>
        <p class="text-xs text-gray-500 mt-1">
          Al seleccionar una sugerencia se rellenar√° el campo Payload autom√°ticamente.
        </p>
      </div>

      <div>
        <label for="payload" class="block font-medium">Payload (PRD:&lt;uuid&gt;)</label>
        <input id="payload" class="w-full border border-gray-300 rounded px-3 py-2" />
      </div>

      <div>
        <label for="loc" class="block font-medium">Ubicaci√≥n</label>
        <select id="loc" class="w-full border border-gray-300 rounded px-3 py-2">
          <option value="" disabled selected>--- Elige ubicaci√≥n ---</option>
          {% for loc in locations %}
            <option value="{{ loc.name }}">{{ loc.name }}</option>
          {% empty %}
            <option disabled>No hay ubicaciones disponibles</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label for="mtype" class="block font-medium">Tipo</label>
        <select id="mtype" class="w-full border border-gray-300 rounded px-3 py-2">
          <option value="OUT">Salida</option>
          <option value="IN">Entrada</option>
          <option value="ADJ">Ajuste</option>
          <option value="AUD">Auditor√≠a</option>
          <option value="AUDTOTAL">Auditor√≠a total</option>
        </select>
      </div>

      <!-- Campos adicionales SOLO cuando tipo = Entrada -->
      <div id="entrada-extra" class="space-y-4 hidden mt-4">
        <div>
          <label for="new_name" class="block font-medium">Nombre del producto</label>
          <input id="new_name" class="w-full border border-gray-300 rounded px-3 py-2" />
        </div>
        <div>
          <label for="new_category" class="block font-medium">Categor√≠a</label>
          <input id="new_category" class="w-full border border-gray-300 rounded px-3 py-2" />
        </div>
        <div>
          <label for="new_unit" class="block font-medium">Unidad</label>
          <input id="new_unit" class="w-full border border-gray-300 rounded px-3 py-2" />
        </div>
        <div>
          <label for="new_min_stock" class="block font-medium">Stock m√≠nimo</label>
          <input id="new_min_stock" type="number" class="w-full border border-gray-300 rounded px-3 py-2" />
        </div>
        <div>
          <label for="new_expiration_date" class="block font-medium">Fecha de caducidad</label>
          <input id="new_expiration_date" type="date" class="w-full border border-gray-300 rounded px-3 py-2" />
        </div>
        <div>
          <label for="new_notes" class="block font-medium">Notas</label>
          <textarea id="new_notes" class="w-full border border-gray-300 rounded px-3 py-2"></textarea>
        </div>
      </div>

      <div>
        <label for="qty" class="block font-medium">Cantidad</label>
        <input id="qty" type="number" value="1" min="1" class="w-full border border-gray-300 rounded px-3 py-2" />
      </div>

      <button class="w-full bg-green-500 text-white py-2 px-4 rounded hover:bg-green-600 transition">Enviar</button>
    </form>

    <!-- Respuesta -->
    <h3 class="text-lg font-semibold mt-6">Respuesta:</h3>
    <pre id="out" class="mt-2 bg-gray-100 border border-gray-300 p-4 rounded min-h-[64px] text-gray-700"></pre>

    <div id="qr-result" class="mt-4 hidden">
      <h4 class="font-semibold">QR generado:</h4>
      <canvas id="qr-canvas" class="border border-gray-300 rounded p-2 bg-white"></canvas>
      <p class="text-sm text-gray-600 mt-1">Este c√≥digo identifica el producto generado.</p>
    </div>

  </div>

  <!-- Scripts -->
  <script>
    // ---- Utilidades CSRF + helpers ----
    function getCookie(name) {
      const v = `; ${document.cookie}`;
      const p = v.split(`; ${name}=`);
      if (p.length === 2) return p.pop().split(';').shift();
    }
    const csrftoken = getCookie('csrftoken');

    function validUUID(u) {
      return /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(u);
    }

    // =============================
    // üîé AUTOCOMPLETADO DE PRODUCTOS
    // =============================
    (function initProductAutocomplete() {
      const searchInput   = document.getElementById('productSearch');
      const datalist      = document.getElementById('productSearchResults');
      const payloadInput  = document.getElementById('payload');
      const locationSelect= document.getElementById('loc');

      // Mapa label -> payload
      const optionMap = new Map();
      let timer = null;
      let lastController = null;

      function debounce(fn, ms) {
        clearTimeout(timer);
        timer = setTimeout(fn, ms);
      }

      async function fetchResults(q) {
        try {
          if (lastController) lastController.abort();
          lastController = new AbortController();

          const params = new URLSearchParams({ q });
          const loc = (locationSelect && locationSelect.value) ? locationSelect.value.trim() : '';
          if (loc) params.set('location', loc);

          const res = await fetch(`/products/search/?${params.toString()}`, { signal: lastController.signal });
          if (!res.ok) throw new Error('HTTP ' + res.status);
          return await res.json();
        } catch (_e) {
          return { results: [] };
        }
      }

      function renderOptions(results) {
        optionMap.clear();
        datalist.innerHTML = results.map(r => {
          const label = [r.name, r.location].filter(Boolean).join(' ‚Äî ');
          optionMap.set(label, r.payload);
          return `<option value="${label}"></option>`;
        }).join('');
      }

      if (searchInput) {
        searchInput.addEventListener('input', () => {
          const q = searchInput.value.trim();
          if (!q) { datalist.innerHTML = ''; optionMap.clear(); return; }
          debounce(async () => {
            const json = await fetchResults(q);
            renderOptions(json.results || []);
          }, 250);
        });

        searchInput.addEventListener('change', () => {
          const val = searchInput.value.trim();
          if (optionMap.has(val)) {
            payloadInput.value = optionMap.get(val); // PRD:...
          }
        });
      }
    })();
    // =============================

    // ---- Env√≠o de formulario ----
    async function enviar() {
      const mtype = document.getElementById('mtype').value;
      const payloadRaw = (document.getElementById('payload').value || '').trim();

      // Validaci√≥n del payload seg√∫n el tipo de movimiento
      if (!['IN', 'AUD', 'AUDTOTAL'].includes(mtype)) {
        if (!payloadRaw.startsWith('PRD:')) { 
          alert('El payload debe empezar por PRD:'); 
          return; 
        }
        const uuid = payloadRaw.slice(4).trim();
        if (!validUUID(uuid)) { 
          alert('UUID no v√°lido.'); 
          return; 
        }
      }

      // Para OUT exigimos PRD:<uuid>, pero no para Auditor√≠a
      if (mtype === 'OUT') {
        if (!payloadRaw.startsWith('PRD:')) {
          alert('El payload debe empezar por PRD:');
          return;
        }
        const uuid = payloadRaw.slice(4).trim();
        if (!validUUID(uuid)) {
          alert('UUID no v√°lido.');
          return;
        }
      }

      const body = {
        payload: payloadRaw,
        quantity: document.getElementById('qty').value || 1,
        location: document.getElementById('loc').value || '',
        movement_type: mtype,
      };

      if (mtype === 'IN') {
        body.new_product = {
          name: document.getElementById('new_name').value || '',
          category: document.getElementById('new_category').value || '',
          unit: document.getElementById('new_unit').value || '',
          min_stock: parseInt(document.getElementById('new_min_stock').value || '0'),
          notes: document.getElementById('new_notes').value || '',
          expiration_date: document.getElementById('new_expiration_date').value || null,
        };
      }

      try {
        const res = await fetch('/api/scan/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
          credentials: 'same-origin',
          body: JSON.stringify(body),
        });

        const raw = await res.text();
        let data;
        try { data = JSON.parse(raw); } catch { data = { non_json: true, raw }; }

        // AUDITOR√çA TOTAL ‚Äî versi√≥n simplificada y fiable
        if (mtype === 'AUDTOTAL') {
          const inv = data?.data?.inventory || data?.inventory || data?.data?.data?.inventory;
          const total = data?.data?.total_locations || data?.total_locations || data?.data?.data?.total_locations;

          if (!inv || !Array.isArray(inv)) {
            document.getElementById("out").innerHTML = `
              <div class="p-4 bg-red-100 text-red-700 rounded">
                <strong>Error:</strong> No se pudo leer el inventario desde la respuesta del servidor.
              </div>
              <pre class="mt-2 text-xs text-gray-600">${JSON.stringify(data, null, 2)}</pre>
            `;
            return;
          }

          let html = `
            <h2 class="text-2xl font-bold text-blue-600 mb-3">üì¶ Auditor√≠a total</h2>
            <p class="text-sm text-gray-700 mb-6">Total de ubicaciones: <b>${total || inv.length}</b></p>
          `;

          inv.forEach(loc => {
            html += `
              <div class="border border-gray-300 rounded-lg p-4 mb-5 bg-gray-50">
                <h3 class="text-lg font-semibold text-gray-800 mb-2">${loc.location}</h3>
                <p class="text-sm text-gray-600 mb-3">Productos en esta ubicaci√≥n: <b>${loc.total_products}</b></p>
                <table class="w-full border-collapse text-sm bg-white rounded-lg overflow-hidden">
                  <thead class="bg-gray-200 text-gray-800">
                    <tr>
                      <th class="border px-3 py-2 text-left">Producto</th>
                      <th class="border px-3 py-2 text-center">Cantidad total</th>
                      <th class="border px-3 py-2 text-center">Caducidad m√°s pr√≥xima</th>
                      <th class="border px-3 py-2 text-left">Lotes</th>
                    </tr>
                  </thead>
                  <tbody>
            `;
            (loc.items || []).forEach(it => {
              const lotes = it.batches?.length
                ? it.batches.map(b => `#${b.id} (${b.quantity}u, ${b.expiration_date || '-'})`).join("<br>")
                : '<span class="text-gray-400 italic">Sin lotes</span>';
              html += `
                <tr class="hover:bg-gray-50">
                  <td class="border px-3 py-2 font-medium">${it.product}</td>
                  <td class="border px-3 py-2 text-center">${it.total_quantity}</td>
                  <td class="border px-3 py-2 text-center">${it.nearest_expiration || '-'}</td>
                  <td class="border px-3 py-2">${lotes}</td>
                </tr>
              `;
            });
            html += `
                  </tbody>
                </table>
              </div>
            `;
          });

          document.getElementById("out").innerHTML = html;
          return;
        }

        if (mtype === 'IN' && data && data.payload) {
          const qrCanvas = document.getElementById('qr-canvas');
          const qrContainer = document.getElementById('qr-result');
          qrContainer.classList.remove('hidden');
          new QRious({ element: qrCanvas, value: data.payload, size: 200, level: 'H' });
        }

        const headersObj = {};
        res.headers.forEach((v, k) => headersObj[k] = v);
        if (mtype === "AUD" && data && data.items) {
          const rows = data.items.map(item => {
            const lotes = item.batches.map(
              b => `<li>Lote #${b.id} ‚Äî ${b.quantity} u. ${b.expiration_date ? `(${b.expiration_date})` : ''}</li>`
            ).join("");
            return `
              <tr>
                <td class="border px-3 py-2 font-medium">${item.product}</td>
                <td class="border px-3 py-2 text-center">${item.total_quantity}</td>
                <td class="border px-3 py-2 text-center">${item.nearest_expiration || "-"}</td>
                <td class="border px-3 py-2"><ul>${lotes}</ul></td>
              </tr>`;
          }).join("");

          const html = `
            <h3 class="text-lg font-semibold mb-2">Auditor√≠a ‚Äî ${data.location}</h3>
            <p class="text-sm text-gray-600 mb-2">Total productos: <b>${data.total_products}</b></p>
            <table class="border-collapse w-full text-sm">
              <thead>
                <tr class="bg-gray-200">
                  <th class="border px-3 py-2 text-left">Producto</th>
                  <th class="border px-3 py-2 text-center">Cantidad total</th>
                  <th class="border px-3 py-2 text-center">Caducidad m√°s pr√≥xima</th>
                  <th class="border px-3 py-2 text-left">Lotes</th>
                </tr>
              </thead>
              <tbody>${rows}</tbody>
            </table>`;
          document.getElementById("out").innerHTML = html;
        } else {
          document.getElementById("out").textContent = JSON.stringify({
            ok: res.ok, status: res.status, headers: headersObj, data
          }, null, 2);
        }

      } catch (e) {
        document.getElementById('out').textContent = 'Error de red: ' + e;
      }
    }

    // ---- Lector QR / C√°mara ----
    let html5Qr; let cameras = []; let currentCamIndex = 0; let lastText = null;

    function onScanSuccess(decodedText) {
      if (decodedText === lastText) return;
      lastText = decodedText;
      document.getElementById('payload').value = decodedText;

      const parts = decodedText.split('|').map(s => s.trim());
      parts.forEach(p => {
        const [key, value] = p.split(':');
        if (!key || !value) return;
        const k = key.toUpperCase();
        if (k === 'LOC') document.getElementById('loc').value = value;
        if (k === 'Q') document.getElementById('qty').value = value;
        if (k === 'T') document.getElementById('mtype').value = value.toUpperCase();
      });
    }

    function onScanError(_msg) {}

    async function startWithFacingMode() {
      await html5Qr.start(
        { facingMode: "environment" },
        { fps: 12, qrbox: 280, rememberLastUsedCamera: true },
        onScanSuccess,
        onScanError
      );
    }

    async function listAndStartPreferred() {
      cameras = await Html5Qrcode.getCameras();
      if (!cameras || !cameras.length) throw new Error("Sin c√°maras");
      const prefer = cameras.find(c => (c.label || "").toLowerCase().match(/back|rear|environment/));
      currentCamIndex = Math.max(0, prefer ? cameras.indexOf(prefer) : 0);
      await html5Qr.start(
        cameras[currentCamIndex].id,
        { fps: 12, qrbox: 280 },
        onScanSuccess,
        onScanError
      );
    }

    async function startScanner() {
      const statusEl = document.getElementById('cam-status');
      try {
        html5Qr = new Html5Qrcode("reader");
        try {
          await startWithFacingMode();
          statusEl.textContent = "C√°mara trasera activa. Enfoca un QR‚Ä¶";
        } catch (_e) {
          await listAndStartPreferred();
          const label = cameras[currentCamIndex]?.label || "c√°mara";
          statusEl.textContent = `C√°mara activa (${label}). Enfoca un QR‚Ä¶`;
        }
      } catch (e) {
        statusEl.textContent = "Error al iniciar la c√°mara: " + e;
        console.error(e);
      }
    }

    async function switchCamera() {
      const statusEl = document.getElementById('cam-status');
      try {
        await html5Qr.stop(); 
        await html5Qr.clear();
        if (!cameras.length) cameras = await Html5Qrcode.getCameras();
        currentCamIndex = (currentCamIndex + 1) % cameras.length;
        await html5Qr.start(
          cameras[currentCamIndex].id,
          { fps: 12, qrbox: 280 },
          onScanSuccess,
          onScanError
        );
        const label = cameras[currentCamIndex]?.label || "c√°mara";
        statusEl.textContent = `C√°mara activa (${label}). Enfoca un QR‚Ä¶`;
      } catch (e) {
        statusEl.textContent = "No se pudo cambiar de c√°mara: " + e;
      }
    }

    // ---- Inicializaci√≥n ----
    document.addEventListener('DOMContentLoaded', () => {
      console.log("DOM cargado, inicializando esc√°ner...");

      // Verificar QR lib
      setTimeout(() => {
        if (typeof Html5Qrcode === 'undefined') {
          console.error('Html5Qrcode no est√° disponible. Verifica la carga de la librer√≠a.');
          document.getElementById('cam-status').textContent = 'Error: Librer√≠a QR no cargada';
          return;
        }
        document.getElementById('switchBtn').addEventListener('click', switchCamera);
        startScanner();
      }, 100);

      // Mostrar/ocultar campos de Entrada
      const tipoSelect = document.getElementById('mtype');
      const extraForm = document.getElementById('entrada-extra');
      const updateExtra = () => {
        if (tipoSelect.value === 'IN') extraForm.classList.remove('hidden');
        else extraForm.classList.add('hidden');
      };
      tipoSelect.addEventListener('change', updateExtra);
      updateExtra();
    });

  </script>
</body>
</html>
