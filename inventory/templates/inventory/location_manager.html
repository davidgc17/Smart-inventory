{% extends "inventory/base.html" %}
{% load static %}
{% block title %}Gesti√≥n de ubicaciones ¬∑ Smart Inventory{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto bg-sky-50 shadow-md rounded-xl p-6 space-y-6
         motion-safe:transition-opacity motion-safe:duration-150">

  <h1 class="text-3xl font-bold text-teal-700">Gesti√≥n de ubicaciones</h1>

  <!-- Mensajes -->
  <div id="msg" class="hidden p-3 rounded text-sm"></div>

  <!-- Crear ubicaci√≥n ra√≠z -->
  <section class="border border-slate-200 rounded-lg p-4 space-y-3">
    <h2 class="text-lg font-semibold text-slate-900">A√±adir ubicaci√≥n ra√≠z</h2>

    <div class="flex flex-col sm:flex-row gap-3 items-stretch sm:items-end">
      <div class="flex-1">
        <label for="root-name" class="block text-sm font-medium text-slate-700">Nombre</label>
        <input id="root-name" type="text"
          class="mt-1 w-full border border-slate-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500"
          placeholder="Ej: Armario del sal√≥n">
      </div>

      <button id="btn-add-root" class="px-4 py-2 bg-teal-600 text-white rounded hover:bg-teal-700 transition">
        Crear
      </button>
    </div>
  </section>

  <!-- Tabla de ubicaciones -->
  <section class="space-y-3">

    <div class="flex items-center justify-between">
      <h2 class="text-lg font-semibold text-slate-900">√Årbol de ubicaciones</h2>

      <button id="btn-refresh" class="text-sm px-3 py-1 border border-slate-300 rounded hover:bg-slate-50">
        Recargar
      </button>
    </div>

    <div class="border border-slate-200 rounded-lg overflow-hidden bg-sky-50">
      <table class="w-full text-sm border-collapse">
        <thead class="bg-slate-50 text-slate-800">
          <tr class="text-sm hover:bg-teal-50/70 motion-safe:transition-colors">
            <th class="border px-3 py-2 text-left w-1/2">Ruta</th>
            <th class="border px-3 py-2 text-left">Nombre</th>
            <th class="border px-3 py-2 text-center">Acciones</th>
          </tr>
        </thead>

        <tbody id="locations-tbody">
          <tr class="text-sm hover:bg-teal-50/70 motion-safe:transition-colors">
            <td colspan="3" class="border px-3 py-3 text-center text-slate-500">
              Cargando ubicaciones‚Ä¶
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <p class="text-xs text-slate-500">
      Puedes a√±adir hijos, renombrar o eliminar ubicaciones.<br>
      No se podr√°n eliminar si tienen sub-ubicaciones, productos o historial asociado.
    </p>

  </section>

</div>
{% endblock %}

{% block extra_js %}
<script>
  /* ======================
     ==   JS ORIGINAL     ==
     ====================== */

  const PAGE_SIZE = 25;
  let LOC_PAGE = 1;
  let LAST_LOC_TREE = [];

  function paginate(items, page) {
    const start = (page - 1) * PAGE_SIZE;
    return items.slice(start, start + PAGE_SIZE);
  }


  function getCookie(name) {
    const v = `; ${document.cookie}`;
    const p = v.split(`; ${name}=`);
    if (p.length === 2) return p.pop().split(";").shift();
  }
  const csrftoken = getCookie("csrftoken");

  const API_BASE = "/api";

  const msgBox = document.getElementById("msg");
  const tbody = document.getElementById("locations-tbody");
  const btnRefresh = document.getElementById("btn-refresh");
  const btnAddRoot = document.getElementById("btn-add-root");
  const rootNameInput = document.getElementById("root-name");

  function showMessage(text, type = "info") {
    msgBox.textContent = text;
    msgBox.classList.remove(
      "hidden",
      "bg-green-50", "text-green-700",
      "bg-red-50", "text-red-700",
      "bg-blue-50", "text-blue-700"
    );
    if (type === "success") {
      msgBox.classList.add("bg-emerald-50", "text-emerald-700");
    } else if (type === "error") {
      msgBox.classList.add("bg-red-50", "text-red-700");
    } else {
      msgBox.classList.add("bg-teal-50", "text-teal-800");
    }
  }

  function clearMessage() {
    msgBox.classList.add("hidden");
    msgBox.textContent = "";
  }

  async function loadTree() {
    try {
      clearMessage();
      tbody.innerHTML = `
        <tr class="text-sm hover:bg-teal-50/70 motion-safe:transition-colors">
          <td colspan="3" class="border px-3 py-3 text-center text-slate-500">
            Cargando ubicaciones‚Ä¶
          </td>
        </tr>
      `;

      const res = await fetch(`${API_BASE}/locations/tree/`, {
        headers: { "Accept": "application/json" },
        credentials: "same-origin",
      });

      const text = await res.text();
      let data;
      try {
        data = JSON.parse(text);
      } catch (e) {
        console.error("Respuesta no JSON en /locations/tree/:", text);
        showMessage(`Error al obtener ubicaciones (${res.status})`, "error");
        return;
      }

      if (!res.ok) {
        console.error("Error tree:", data);
        showMessage(`Error al obtener ubicaciones (${res.status})`, "error");
        return;
      }

      const tree = data.tree || [];
      LAST_LOC_TREE = tree;
      LOC_PAGE = 1;
      renderTree(LAST_LOC_TREE);
    } catch (e) {
      console.error(e);
      showMessage("Error de red al cargar ubicaciones", "error");
    }
  }

  function renderTree(tree) {
    const rows = [];
    function walk(nodes, depth) {
      nodes.forEach((node) => {
        rows.push(rowForNode(node, depth));
        if (node.children && node.children.length) {
          walk(node.children, depth + 1);
        }
      });
    }
    walk(tree, 0);

    if (!rows.length) {
      tbody.innerHTML = `
        <tr class="text-sm hover:bg-teal-50/70 motion-safe:transition-colors">
          <td colspan="3" class="border px-3 py-3 text-center text-slate-500">
            No hay ubicaciones. Crea una ubicaci√≥n ra√≠z para empezar.
          </td>
        </tr>
      `;
    } else {
      const totalRows = rows.length;
      const totalPages = Math.ceil(totalRows / PAGE_SIZE) || 1;

      if (LOC_PAGE < 1) LOC_PAGE = 1;
      if (LOC_PAGE > totalPages) LOC_PAGE = totalPages;

      const pageRows = paginate(rows, LOC_PAGE);
      tbody.innerHTML = pageRows.join("");

      // üîΩ PAGINADOR
      if (totalPages > 1) {
        const pagerRow = document.createElement("tr");
        pagerRow.innerHTML = `
          <td colspan="3" class="border px-3 py-3">
            <div class="flex justify-center items-center gap-4 text-sm">
              <button class="prev px-3 py-1 border rounded disabled:opacity-40"
                      ${LOC_PAGE === 1 ? "disabled" : ""}>
                ‚Üê Anterior
              </button>

              <span>P√°gina ${LOC_PAGE} / ${totalPages}</span>

              <button class="next px-3 py-1 border rounded disabled:opacity-40"
                      ${LOC_PAGE === totalPages ? "disabled" : ""}>
                Siguiente ‚Üí
              </button>
            </div>
          </td>
        `;

        pagerRow.querySelector(".prev").onclick = () => {
          if (LOC_PAGE > 1) {
            LOC_PAGE--;
            renderTree(LAST_LOC_TREE);
          }
        };

        pagerRow.querySelector(".next").onclick = () => {
          if (LOC_PAGE < totalPages) {
            LOC_PAGE++;
            renderTree(LAST_LOC_TREE);
          }
        };

        tbody.appendChild(pagerRow);
      }
    }

  }

  function rowForNode(node, depth) {
    const indent = depth * 1.5;
    const safePath = node.path || node.name;

    return `
    <tr class="hover:bg-slate-50">
      <td class="border px-3 py-2 text-slate-800">
        <span style="padding-left:${indent}rem" class="inline-block">
          ${safePath}
        </span>
      </td>
      <td class="border px-3 py-2">
        ${node.name}
      </td>
      <td class="border px-3 py-2 text-center space-x-2">
        <button class="text-xs px-2 py-1 bg-emerald-50 text-emerald-800 rounded hover:bg-emerald-100"
                data-action="add-child" data-id="${node.id}">
          + Hijo
        </button>
        <button class="text-xs px-2 py-1 bg-teal-50 text-teal-800 rounded hover:bg-teal-100"
                data-action="rename" data-id="${node.id}">
          Renombrar / mover
        </button>
        <button class="text-xs px-2 py-1 bg-red-50 text-red-800 rounded hover:bg-red-100"
                data-action="delete" data-id="${node.id}">
          Eliminar
        </button>
      </td>
    </tr>
    `;
  }

  async function createRoot() {
    const name = (rootNameInput.value || "").trim();
    if (!name) {
      showMessage("Introduce un nombre para la ubicaci√≥n ra√≠z", "error");
      return;
    }

    try {
      const res = await fetch(`${API_BASE}/locations/create/`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrftoken,
        },
        credentials: "same-origin",
        body: JSON.stringify({ name }),
      });

      const text = await res.text();
      let data;
      try { data = JSON.parse(text); }
      catch {
        console.error("Respuesta no JSON en create:", text);
        showMessage(`Error al crear ubicaci√≥n (${res.status})`, "error");
        return;
      }

      if (!res.ok || data.ok === false) {
        console.error("Create error:", data);
        if (data.error === "duplicate_name") {
          showMessage("Ya existe una ubicaci√≥n con ese nombre en este nivel.", "error");
        } else {
          showMessage(data.detail || "No se pudo crear la ubicaci√≥n", "error");
        }
        return;
      }

      rootNameInput.value = "";
      showMessage("Ubicaci√≥n ra√≠z creada correctamente", "success");
      await loadTree();
    } catch (e) {
      console.error(e);
      showMessage("Error de red al crear ubicaci√≥n", "error");
    }
  }

  async function handleRowClick(e) {
    const btn = e.target.closest("button[data-action]");
    if (!btn) return;

    const action = btn.dataset.action;
    const id = btn.dataset.id;
    if (!id) return;

    if (action === "add-child") {
      await addChild(id);
    } else if (action === "rename") {
      await renameOrMove(id);
    } else if (action === "delete") {
      await deleteLocation(id);
    }
  }

  async function addChild(parentId) {
    const name = prompt("Nombre de la nueva sub-ubicaci√≥n:");
    if (!name) return;

    try {
      const res = await fetch(`${API_BASE}/locations/create/`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrftoken,
        },
        credentials: "same-origin",
        body: JSON.stringify({ name: name.trim(), parent_id: parentId }),
      });

      const text = await res.text();
      let data;
      try { data = JSON.parse(text); }
      catch {
        console.error("Respuesta no JSON en addChild:", text);
        showMessage(`Error al crear sub-ubicaci√≥n (${res.status})`, "error");
        return;
      }

      if (!res.ok || data.ok === false) {
        console.error("Add-child error:", data);
        if (data.error === "duplicate_name") {
          showMessage("Ya existe una sub-ubicaci√≥n con ese nombre en este nivel.", "error");
        } else {
          showMessage(data.detail || "No se pudo crear la sub-ubicaci√≥n", "error");
        }
        return;
      }

      showMessage("Sub-ubicaci√≥n creada correctamente", "success");
      await loadTree();
    } catch (e) {
      console.error(e);
      showMessage("Error de red al crear sub-ubicaci√≥n", "error");
    }
  }

  async function renameOrMove(locId) {
    const newName = prompt("Nuevo nombre (deja vac√≠o para mantener el actual):");
    const parentIdStr = prompt("Nuevo padre (ID UUID) o vac√≠o para mantener el padre actual:");

    const payload = {};
    if (newName && newName.trim()) payload.name = newName.trim();
    if (parentIdStr && parentIdStr.trim()) payload.parent_id = parentIdStr.trim();
    if (!Object.keys(payload).length) return;

    try {
      const res = await fetch(`${API_BASE}/locations/update/${locId}/`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrftoken,
        },
        credentials: "same-origin",
        body: JSON.stringify(payload),
      });

      const text = await res.text();
      let data;
      try { data = JSON.parse(text); }
      catch {
        console.error("Respuesta no JSON en update:", text);
        showMessage(
          `Error al actualizar ubicaci√≥n (${res.status}). Mira la consola.`,
          "error"
        );
        return;
      }

      if (!res.ok || data.ok === false) {
        console.error("Update error:", data);
        if (data.error === "duplicate_name") {
          showMessage("Ya existe otra ubicaci√≥n con ese nombre en este nivel.", "error");
        } else {
          showMessage(data.detail || `No se pudo actualizar (status ${res.status})`, "error");
        }
        return;
      }

      showMessage("Ubicaci√≥n actualizada correctamente", "success");
      await loadTree();
    } catch (e) {
      console.error(e);
      showMessage("Error de red al actualizar ubicaci√≥n", "error");
    }
  }

  async function deleteLocation(locId) {
    if (!confirm(
      "¬øSeguro que quieres eliminar esta ubicaci√≥n? (solo posible si no tiene sub-ubicaciones, productos ni historial asociado)"
    )) {
      return;
    }

    try {
      const res = await fetch(`${API_BASE}/locations/delete/${locId}/`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrftoken,
        },
        credentials: "same-origin",
        body: JSON.stringify({}),
      });

      const text = await res.text();
      let data;
      try { data = JSON.parse(text); }
      catch {
        console.error("Respuesta no JSON en delete:", text);
        showMessage(
          `Error al eliminar ubicaci√≥n (${res.status}). Mira la consola.`,
          "error"
        );
        return;
      }

      if (!res.ok || data.ok === false) {
        console.error("Delete error:", data);
        if (data.error === "location_in_use") {
          showMessage(
            "No se puede eliminar: la ubicaci√≥n tiene sub-ubicaciones, productos o historial asociado.",
            "error"
          );
        } else {
          showMessage(data.detail || `No se pudo eliminar (status ${res.status})`, "error");
        }
        return;
      }

      showMessage("Ubicaci√≥n eliminada", "success");
      await loadTree();
    } catch (e) {
      console.error(e);
      showMessage("Error de red al eliminar ubicaci√≥n", "error");
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    tbody.addEventListener("click", handleRowClick);
    btnRefresh.addEventListener("click", loadTree);
    btnAddRoot.addEventListener("click", createRoot);
    loadTree();
  });
</script>
{% endblock %}